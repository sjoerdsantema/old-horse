AWSTemplateFormatVersion: '2010-09-09'
Description: Non-critical parts like codedeploy, alerts, and more
Parameters:
  AsgGroup:
    Type: String
    Description: Autoscaling group from app stack
Resources:
  AssumeRole: #assume role
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
               - codedeploy.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: "/"
  EC2Policy: #create policy
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: EC2Policy
      PolicyDocument:
        Statement:
          - Effect: Allow
            Action:
              - codecommit:BatchGetRepositories
              - codecommit:Get*
              - codecommit:GitPull
              - codecommit:List*
              - autoscaling:*
              - codedeploy:*
              - ec2:*
              - cloudwatch:*
              - elasticloadbalancing:*
              - iam:AddRoleToInstanceProfile
              - iam:CreateInstanceProfile
              - iam:CreateRole
              - iam:DeleteInstanceProfile
              - iam:DeleteRole
              - iam:DeleteRolePolicy
              - iam:GetInstanceProfile
              - iam:GetRole
              - iam:GetRolePolicy
              - iam:ListInstanceProfilesForRole
              - iam:ListRolePolicies
              - iam:ListRoles
              - iam:PassRole
              - iam:PutRolePolicy
              - iam:RemoveRoleFromInstanceProfile
              - s3:*
            Resource: "*"
      Roles:
        - !Ref AssumeRole
  CodeDeploy:
    Type: AWS::CodeDeploy::Application
    Properties:
      ComputePlatform: Server
  DeploymentGroup:
    Type: AWS::CodeDeploy::DeploymentGroup
    Properties:
      ApplicationName: !Ref CodeDeploy
      AutoScalingGroups:
        - !Ref AsgGroup
      DeploymentConfigName: CodeDeployDefault.OneAtATime
      DeploymentStyle:
        DeploymentOption: WITHOUT_TRAFFIC_CONTROL
        DeploymentType: IN_PLACE
      ServiceRoleArn: !GetAtt AssumeRole.Arn
  SpendingAlarm: #prevent things breaking the bank
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: "Alarm if spending is over 50USD this month"
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Dimensions:
        - Name: Currency
          Value: USD
      Statistic: Maximum
      Period: '21600'
      EvaluationPeriods: '1'
      Threshold: 50
      ComparisonOperator: GreaterThanThreshold
      AlarmActions:
        - !Ref AlarmTopic
      InsufficientDataActions:
        - !Ref AlarmTopic
  AlarmTopic:
    Type: AWS::SNS::Topic
    Properties:
      Subscription:
        - Endpoint: "sjoerdsantema@gmail.com"
          Protocol: 'email'
