AWSTemplateFormatVersion: '2010-09-09'
Description: Non-critical parts like codedeploy, alerts, etc.
Parameters:
  AsgGroup:
    Type: String
    Description: Autoscaling group from app stack
Resources:
  DeployRole: #create codedeploy role
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
               - autoscaling:CompleteLifecycleAction
               - autoscaling:DeleteLifecycleHook
               - autoscaling:DescribeAutoScalingGroups
               - autoscaling:DescribeLifecycleHooks
               - autoscaling:PutLifecycleHook
               - autoscaling:RecordLifecycleActionHeartbeat
               - autoscaling:CreateAutoScalingGroup
               - autoscaling:UpdateAutoScalingGroup
               - autoscaling:EnableMetricsCollection
               - autoscaling:DescribeAutoScalingGroups
               - autoscaling:DescribePolicies
               - autoscaling:DescribeScheduledActions
               - autoscaling:DescribeNotificationConfigurations
               - autoscaling:DescribeLifecycleHooks
               - autoscaling:SuspendProcesses
               - autoscaling:ResumeProcesses
               - autoscaling:AttachLoadBalancers
               - autoscaling:PutScalingPolicy
               - autoscaling:PutScheduledUpdateGroupAction
               - autoscaling:PutNotificationConfiguration
               - autoscaling:PutLifecycleHook
               - autoscaling:DescribeScalingActivities
               - autoscaling:DeleteAutoScalingGroup
               - ec2:DescribeInstances
               - ec2:DescribeInstanceStatus
               - ec2:TerminateInstances
               - tag:GetTags
               - tag:GetResources
               - sns:Publish
               - cloudwatch:DescribeAlarms
               - cloudwatch:PutMetricAlarm
               - elasticloadbalancing:DescribeLoadBalancers
               - elasticloadbalancing:DescribeInstanceHealth
               - elasticloadbalancing:RegisterInstancesWithLoadBalancer
               - elasticloadbalancing:DeregisterInstancesFromLoadBalancer
               - elasticloadbalancing:DescribeTargetGroups
               - elasticloadbalancing:DescribeTargetHealth
               - elasticloadbalancing:RegisterTargets
               - elasticloadbalancing:DeregisterTargets
               - codedeploy.amazonaws.com
               - codedeploy.us-east-2.amazonaws.com
               - codedeploy.us-east-1.amazonaws.com
               - codedeploy.us-west-1.amazonaws.com
               - codedeploy.us-west-2.amazonaws.com
               - codedeploy.eu-west-3.amazonaws.com
               - codedeploy.ca-central-1.amazonaws.com
               - codedeploy.eu-west-1.amazonaws.com
               - codedeploy.eu-west-2.amazonaws.com
               - codedeploy.eu-central-1.amazonaws.com
               - codedeploy.ap-northeast-1.amazonaws.com
               - codedeploy.ap-northeast-2.amazonaws.com
               - codedeploy.ap-southeast-1.amazonaws.com
               - codedeploy.ap-southeast-2.amazonaws.com
               - codedeploy.ap-south-1.amazonaws.com
               - codedeploy.sa-east-1.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: "/"
  CodeDeploy:
    Type: AWS::CodeDeploy::Application
    Properties:
      ComputePlatform: Server
  DeploymentGroup:
    Type: AWS::CodeDeploy::DeploymentGroup
    Properties:
      ApplicationName: !Ref CodeDeploy
      AutoScalingGroups:
        - !Ref AsgGroup
      DeploymentConfigName: CodeDeployDefault.OneAtATime
      DeploymentStyle:
        DeploymentOption: WITHOUT_TRAFFIC_CONTROL
        DeploymentType: IN_PLACE
      ServiceRoleArn: !GetAtt DeployRole.Arn
  SpendingAlarm: #prevent things breaking the bank
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: "Alarm if spending is over 50USD this month"
      Namespace: AWS/Billing
      MetricName: EstimatedCharges
      Dimensions:
        - Name: Currency
          Value: USD
      Statistic: Maximum
      Period: '21600'
      EvaluationPeriods: '1'
      Threshold: 50
      ComparisonOperator: GreaterThanThreshold
      AlarmActions:
        - !Ref AlarmTopic
      InsufficientDataActions:
        - !Ref AlarmTopic
  AlarmTopic:
    Type: AWS::SNS::Topic
    Properties:
      Subscription:
        - Endpoint: "sjoerdsantema@gmail.com"
          Protocol: 'email'
